# 内存单位显示修复

## 问题描述
图表中的内存数据显示单位不一致，Y轴显示的是字节数（如1,000,000,000），但图例标注的是MB单位，造成用户困惑。

## 问题分析
1. **后端数据处理**: 某些GC日志（特别是IBM J9VM）的内存数据以字节为单位
2. **单位转换阈值**: 原来的转换阈值设置为1GB（1,000,000,000字节），太高了
3. **前端显示格式**: Y轴格式化函数需要处理MB到GB的转换

## 修复方案

### 1. 后端数据转换优化 (web_optimizer.py)

**修复前**:
```python
if heap_before > 1000000000:  # 如果大于1GB，假设是字节单位
    heap_before = heap_before / (1024 * 1024)
```

**修复后**:
```python
if heap_before > 1048576:  # 如果大于1MB，假设是字节单位
    heap_before = heap_before / (1024 * 1024)
```

**改进点**:
- 降低转换阈值从1GB到1MB（1,048,576字节）
- 更准确地识别字节单位的数据
- 统一处理所有内存区域（堆、Eden、Survivor、Metaspace等）

### 2. 前端Y轴格式化 (web_frontend.py)

**添加Y轴格式化函数**:
```javascript
y: { 
    title: { display: true, text: '内存使用 (MB)' },
    ticks: {
        callback: function(value, index, values) {
            // 确保Y轴显示为MB单位，如果值太大则转换
            if (value >= 1024) {
                return (value / 1024).toFixed(1) + 'GB';
            }
            return Math.round(value) + 'MB';
        }
    }
}
```

**改进点**:
- 自动将大于等于1024MB的值显示为GB
- 保持小于1024MB的值显示为MB
- 数值四舍五入，提高可读性

### 3. 数据验证和测试

**测试用例**:
```python
test_cases = [
    (536_870_912, 512, "512MB字节数据"),      # 512MB in bytes
    (1_073_741_824, 1024, "1GB字节数据"),     # 1GB in bytes  
    (2_147_483_648, 2048, "2GB字节数据"),     # 2GB in bytes
    (512, 512, "已经是MB的数据"),
    (1024, 1024, "1GB的MB数据"),
]
```

**验证结果**:
- ✅ 字节到MB转换正确
- ✅ 已是MB单位的数据保持不变
- ✅ 数值范围合理（避免异常大的数值）

## 修复效果

### 修复前
- Y轴显示: 1,000,000,000 (字节)
- 图例显示: 堆内存使用 (MB)
- 用户困惑: 数值和单位不匹配

### 修复后
- Y轴显示: 1000MB 或 1.0GB
- 图例显示: 堆内存使用 (MB)
- 用户体验: 数值和单位一致，易于理解

## 影响的图表

1. **堆内存使用趋势图**
   - 堆内存使用前/后
   - Eden区使用情况
   - Survivor区使用情况
   - 老年代使用情况
   - Metaspace使用情况

2. **分代内存变化对比图**
   - 各内存区域的对比显示
   - 内存回收效果展示

## 技术细节

### 内存单位转换逻辑
```python
def convert_memory_to_mb(value):
    """将内存值转换为MB单位"""
    if value > 1048576:  # 大于1MB，假设是字节
        return value / (1024 * 1024)
    else:  # 已经是MB或更小单位
        return value
```

### Y轴显示格式
```javascript
function formatMemoryValue(value) {
    if (value >= 1024) {
        return (value / 1024).toFixed(1) + 'GB';
    }
    return Math.round(value) + 'MB';
}
```

## 测试验证

### 单元测试
- ✅ 内存单位转换逻辑测试
- ✅ 图表数据生成测试  
- ✅ 前端显示格式测试

### 集成测试
- ✅ 完整的GC日志处理流程
- ✅ 图表渲染和显示效果
- ✅ 不同GC类型的兼容性

### 用户体验测试
- ✅ 数值显示直观易懂
- ✅ 单位标注一致
- ✅ 图表缩放和交互正常

## 总结

通过这次修复：
1. **解决了单位显示不一致的问题**
2. **提高了数据的可读性和准确性**
3. **增强了用户体验**
4. **保持了对不同GC日志格式的兼容性**

现在用户看到的图表将显示正确的内存单位，如：
- 512MB（而不是536,870,912）
- 1.0GB（而不是1,073,741,824）
- 2.5GB（而不是2,684,354,560）

这使得GC性能分析更加直观和准确。